<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HERVE TECH LTD :: Invoice Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-title {
            text-align: center;
            color: #333;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .buttons-container {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .item-container {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        /* Invoice Preview Styles */
        #invoicePreview {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .invoice-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .invoice-table th,
        .invoice-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .invoice-table th {
            background-color: #f4f4f4;
        }

        .total-row {
            font-weight: bold;
        }
        @media print {
            .invoice-container {
                width: 210mm;  /* A4 width */
                padding: 20mm;
                margin: 0;
            }
            
            .invoice-table {
                font-size: 12px;
            }
        }
        
        /* Make sure the preview matches PDF dimensions */
        #invoicePreview .invoice-container {
            width: 210mm;
            margin: 0 auto;
            background: white;
            padding: 20mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
    </style>
    <!-- Add jsPDF and html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>
    <div class="container">
        <h1 class="form-title">Item Entry Form</h1>
        <form id="itemForm">
            <div class="client-info">
                <div class="form-row">
                    <div class="form-group">
                        <label for="invoiceFor">Invoice For</label>
                        <input type="text" id="invoiceFor" required>
                    </div>
                    <div class="form-group">
                        <label for="clientName">Client Name</label>
                        <input type="text" id="clientName" required>
                    </div>
                    <div class="form-group">
                        <label for="clientPhone">Phone Number</label>
                        <input type="tel" id="clientPhone" required>
                    </div>
                </div>
            </div>

            <div id="itemsContainer"></div>

            <div class="client-info">
                <div class="form-row">
                    <div class="form-group">
                        <label for="labourAmount">Labour Amount</label>
                        <input type="number" id="labourAmount" required>
                    </div>
                </div>
            </div>

            <div class="buttons-container">
                <button type="button" class="btn btn-primary" id="addItemBtn">Add Another Item</button>
                <button type="submit" class="btn btn-primary">Generate Invoice</button>
            </div>
        </form>

        <!-- Invoice Preview Container -->
        <div id="invoicePreview"></div>
    </div>

    <script>
        let itemCount = 0;

        function createItemFields() {
            itemCount++;
            const itemContainer = document.createElement('div');
            itemContainer.className = 'item-container';
            itemContainer.id = `item-${itemCount}`;

            itemContainer.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label for="name-${itemCount}">Item Name</label>
                        <input type="text" id="name-${itemCount}" required>
                    </div>
                    <div class="form-group">
                        <label for="quantity-${itemCount}">Quantity</label>
                        <input type="number" id="quantity-${itemCount}" required min="1">
                    </div>
                    <div class="form-group">
                        <label for="price-${itemCount}">Price</label>
                        <input type="number" id="price-${itemCount}" step="0.01" required min="0">
                    </div>
                </div>
                ${itemCount > 1 ? `<button type="button" class="btn btn-danger" onclick="removeItem(${itemCount})">Remove</button>` : ''}
            `;

            document.getElementById('itemsContainer').appendChild(itemContainer);
        }

        function removeItem(id) {
            const item = document.getElementById(`item-${id}`);
            item.remove();
        }

        function collectFormData() {
            const clientData = {
                name: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                invoiceFor: document.getElementById('invoiceFor').value
            };

            const items = [];
            const containers = document.querySelectorAll('.item-container');

            containers.forEach(container => {
                const id = container.id.split('-')[1];
                items.push({
                    name: document.getElementById(`name-${id}`).value,
                    quantity: Number(document.getElementById(`quantity-${id}`).value),
                    price: Number(document.getElementById(`price-${id}`).value)
                });
            });

            const labourAmount = Number(document.getElementById('labourAmount').value);

            return {
                client: clientData,
                items: items,
                labourAmount: labourAmount
            };
        }

        function generateInvoiceHTML(data) {
            const date = new Date().toLocaleDateString();
            let totalAmount = 0;
            const itemRows = data.items.map((item, index) => {
                const itemTotal = item.quantity * item.price;
                totalAmount += itemTotal;
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.price} Rwf</td>
                        <td>${itemTotal} Rwf</td>
                    </tr>
                `;
            }).join('');

            const grandTotal = totalAmount + data.labourAmount;

            return `
                <div class="invoice-container">
                    <h1>Proforma Invoice</h1>
                    <div class="section">
                        <div class="section-header">Client Details:</div>
                        <p>Name: ${data.client.name}</p>
                        <p>Contact: ${data.client.phone}</p>
                    </div>
                    <div class="section">
                        <p>Date: ${date}</p>
                        <p>Invoice For: ${data.client.invoiceFor}</p>
                    </div>
                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th>NO</th>
                                <th>ITEM</th>
                                <th>QTY</th>
                                <th>PRICE/ITEM</th>
                                <th>TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemRows}
                            <tr class="total-row">
                                <td colspan="4">Total</td>
                                <td>${totalAmount} Rwf</td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="4">Labour</td>
                                <td>${data.labourAmount} Rwf</td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="4">Grand Total</td>
                                <td>${grandTotal} Rwf</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="section technician-details">
                        <div class="section-header">Technician Details:</div>
                        <p>Name: Mugabo Herve</p>
                        <p>Contact: +250788861535</p>
                    </div>
                </div>
            `;
        }

        createItemFields();

        document.getElementById('addItemBtn').addEventListener('click', createItemFields);

        document.getElementById('itemForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = collectFormData();

            // Generate and display invoice preview
            const invoicePreview = document.getElementById('invoicePreview');
            invoicePreview.style.display = 'block';
            invoicePreview.innerHTML = generateInvoiceHTML(formData);

            // Generate PDF
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Use html2canvas to convert the invoice preview to an image
                const invoice = invoicePreview.querySelector('.invoice-container');
                const canvas = await html2canvas(invoice, {
                    scale: 2, // Increase quality
                    useCORS: true,
                    logging: false
                });

                const imgData = canvas.toDataURL('image/jpeg', 1.0);

                // Calculate dimensions
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                doc.save('invoice.pdf');

                // Clear form
                document.getElementById('itemForm').reset();
                document.getElementById('itemsContainer').innerHTML = '';
                createItemFields();

                // Hide preview after successful PDF generation
                invoicePreview.style.display = 'none';
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
            }
        });
    </script>
</body>

</html>